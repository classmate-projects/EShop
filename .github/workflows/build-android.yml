name: Build Signed MAUI Android APK (PR Only)

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: windows-latest
    env:
      PROJECT_PATH: EShopNative.csproj

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Install MAUI workload
        run: dotnet workload install maui

      - name: Restore
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Decode Android keystore
        shell: pwsh
        run: |
          [IO.File]::WriteAllBytes(
            "eshop.keystore",
            [Convert]::FromBase64String("${{ secrets.ANDROID_KEYSTORE_BASE64 }}")
          )

      - name: Build Signed APK
        shell: pwsh
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} -c Release -f net10.0-android `
            /p:AndroidPackageFormat=apk `
            /p:AndroidKeyStore=true `
            /p:AndroidSigningKeyStore=eshop.keystore `
            /p:AndroidSigningKeyAlias=${{ secrets.ANDROID_KEY_ALIAS }} `
            /p:AndroidSigningKeyPass=${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }} `
            /p:AndroidSigningStorePass=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: eshop-apk
          path: "bin/Release/net10.0-android/publish/*.apk"

      - name: Cleanup keystore
        run: Remove-Item eshop.keystore -Force -ErrorAction SilentlyContinue
